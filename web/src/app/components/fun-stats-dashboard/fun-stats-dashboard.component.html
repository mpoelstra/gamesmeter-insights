<section class="fun">
  <div class="grid four">
    <app-stats-card class="card-300" [title]="i18n.t('fun.firstLast')">
      @if (firstLast()) {
        <p class="value">{{ firstLast()!.first.title }}</p>
        <p class="muted">{{ i18n.t('fun.firstRated', { date: i18n.formatDate(firstLast()!.first.placed) }) }}</p>
        <p class="value">{{ firstLast()!.last.title }}</p>
        <p class="muted">{{ i18n.t('fun.latestRated', { date: i18n.formatDate(firstLast()!.last.placed) }) }}</p>
      } @else {
        <p class="muted">{{ i18n.t('fun.noDates') }}</p>
      }
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.longestGap')">
      @if (longestGap()) {
        <p class="value">{{ i18n.t('fun.days', { count: longestGap()!.days }) }}</p>
        <p class="muted">
          {{ i18n.t('fun.noRatingsBetween', {
            from: i18n.formatDate(longestGap()!.from),
            to: i18n.formatDate(longestGap()!.to)
          }) }}
        </p>
      } @else {
        <p class="muted">{{ i18n.t('fun.notEnoughGaps') }}</p>
      }
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.tasteShift')">
      @if (tasteShift()) {
        <p class="value">
          {{ tasteShift()!.delta >= 0 ? '⬆' : '⬇' }} {{ tasteShift()!.delta.toFixed(2) }}
        </p>
        <p class="muted">{{ i18n.t('fun.comparedPrev') }}</p>
      } @else {
        <p class="muted">{{ i18n.t('fun.notEnoughYears') }}</p>
      }
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.platformPersonality')">
      @if (topPlatformName()) {
        <div class="platform-line">
          <app-platform-logo
            [src]="platformImage(topPlatformName()).src"
            [alt]="topPlatformName()!"
            [size]="28"
          />
          <p class="value">{{ platformPersonality() ?? i18n.t('fun.loading') }}</p>
        </div>
      } @else {
      <p class="value">{{ platformPersonality() ?? i18n.t('fun.loading') }}</p>
      }
      <p class="muted">{{ i18n.t('fun.platformPersonality.note') }}</p>
    </app-stats-card>
    
    <app-stats-card class="card-300" [title]="i18n.t('fun.ratingRituals')">
      <div card-actions class="ritual-controls" role="tablist" [attr.aria-label]="i18n.t('fun.ritualViewLabel')">
          <button
            class="chip"
            type="button"
            [class.active]="ritualView() === 'month'"
            (click)="ritualView.set('month')"
          >
            {{ i18n.t('fun.month') }}
          </button>
          <button
            class="chip"
            type="button"
            [class.active]="ritualView() === 'weekday'"
            (click)="ritualView.set('weekday')"
          >
            {{ i18n.t('fun.weekday') }}
          </button>
          <button
            class="chip"
            type="button"
            [class.active]="ritualView() === 'year'"
            (click)="ritualView.set('year')"
          >
            {{ i18n.t('fun.year') }}
          </button>
      </div>
      <p class="muted">{{ i18n.t('fun.busiest', { label: busiestRitual().label }) }}</p>
      <div
        class="rituals"
        [class.rituals-year]="ritualView() === 'year'"
        [class.rituals-weekday]="ritualView() === 'weekday'"
      >
        @for (item of ritualStats(); track item.label) {
          <div class="month">
            <span class="bar" [style.height.%]="barHeight(item.count)"></span>
            <span class="label">{{ item.label }}</span>
          </div>
        }
      </div>
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.weekdayMetrics')">
      <p class="muted">
        {{ i18n.t('fun.mostOftenOn') }}
        <strong>{{ weekdayMetrics().busiest.label }}</strong>
        ({{ weekdayMetrics().busiest.count }}).
      </p>
      <p class="muted">
        {{ i18n.t('fun.leastOftenOn') }}
        <strong>{{ weekdayMetrics().quietest.label }}</strong>
        ({{ weekdayMetrics().quietest.count }}).
      </p>
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.busiestDate')">
      @if (busiestDate()) {
        <p class="value">{{ i18n.formatDate(busiestDate()!.date) }}</p>
        <p class="muted">{{ i18n.t('fun.ratingsOnDay', { count: busiestDate()!.count }) }}</p>
      } @else {
        <p class="muted">{{ i18n.t('fun.noDates') }}</p>
      }
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.sameScoreStreak')">
      @if (ratingStreak()) {
        <p class="value">{{ i18n.t('fun.inARow', { count: ratingStreak()!.length }) }}</p>
        <p class="muted">{{ i18n.t('fun.longestStreakAt', { rating: ratingStreak()!.rating.toFixed(1) }) }}</p>
        <p class="muted">
          {{ i18n.formatDate(ratingStreak()!.start) }} – {{ i18n.formatDate(ratingStreak()!.end) }}
        </p>
      } @else {
        <p class="muted">{{ i18n.t('fun.noStreak') }}</p>
      }
    </app-stats-card>
    
    <app-stats-card class="card-300" [title]="i18n.t('fun.mostReplayed')">
      @if (mostReplayedFranchise()) {
        <p class="value">{{ mostReplayedFranchise()!.name }}</p>
        <p class="muted">{{ i18n.t('fun.replayedCount', { count: mostReplayedFranchise()!.count }) }}</p>
      } @else {
        <p class="muted">{{ i18n.t('fun.noFranchise') }}</p>
      }
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.mostPolarizing')">
      @if (mostPolarizingYear()) {
        <p class="value">{{ mostPolarizingYear()!.year }}</p>
        <p class="muted">
          {{ i18n.t('fun.spreadAcross', {
            value: mostPolarizingYear()!.stdDev.toFixed(2),
            count: mostPolarizingYear()!.count
          }) }}
        </p>
      } @else {
        <p class="muted">{{ i18n.t('fun.notEnoughRatings') }}</p>
      }
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.peakYear')">
      @if (busiestYear()) {
        <p class="value">{{ busiestYear()!.year }}</p>
        <p class="muted">{{ i18n.t('fun.peakYearCount', { count: busiestYear()!.count }) }}</p>
      } @else {
        <p class="muted">{{ i18n.t('fun.noYearData') }}</p>
      }
    </app-stats-card>

    <app-stats-card class="card-300" [title]="i18n.t('fun.epicTitle')">
      @if (longestTitle()) {
        <p class="value">{{ longestTitle()!.title }}</p>
        <p class="muted">{{ i18n.t('fun.titleLength', { count: longestTitle()!.length }) }}</p>
      } @else {
        <p class="muted">{{ i18n.t('fun.noTitles') }}</p>
      }
    </app-stats-card>
  </div>
</section>
