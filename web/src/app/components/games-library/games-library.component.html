<article class="library-layout">
  <div class="card library-main">
    <div class="library-actions">
      <div class="view-toggle" role="group" [attr.aria-label]="i18n.t('library.view')">
        <button
          type="button"
          [class.active]="viewMode() === 'list'"
          (click)="setView('list')"
        >
          {{ i18n.t('library.viewList') }}
        </button>
        <button
          type="button"
          [class.active]="viewMode() === 'tiles'"
          (click)="setView('tiles')"
        >
          {{ i18n.t('library.viewTiles') }}
        </button>
      </div>
      <button type="button" class="clear-button" (click)="clearFilters()">
        {{ i18n.t('filters.clear') }}
      </button>
    </div>
    <div class="library-header">
      <h3>{{ i18n.t('library.title') }}</h3>
      <p class="muted">{{ i18n.t('library.subtitle') }}</p>
      <p class="summary">{{ i18n.t('library.summary', { filtered: filteredCount, total: totalCount }) }}</p>
    </div>

    <div class="filters-row">
      <div class="filters">
        <label class="filter filter-search">
          {{ i18n.t('filters.search') }}
          <input type="search" [value]="query()" (input)="updateQuery($any($event.target).value)" />
        </label>
        <label class="filter filter-platform">
          {{ i18n.t('filters.platform') }}
          <select [value]="platformFilter()" (change)="updatePlatform($any($event.target).value)">
            @for (platform of platforms; track platform) {
              <option [value]="platform" [selected]="platformFilter() === platform">
                {{ platform === 'all' ? i18n.t('filters.allPlatforms') : platform }}
              </option>
            }
          </select>
        </label>
        <label class="filter">
          {{ i18n.t('filters.year') }}
          <select [value]="yearFilter()" (change)="updateYear($any($event.target).value)">
            @for (year of years; track year) {
              <option [value]="year">{{ year === 'all' ? i18n.t('filters.allYears') : year }}</option>
            }
          </select>
        </label>
        <label class="filter">
          {{ i18n.t('filters.ratedYear') }}
          <select [value]="ratedYearFilter()" (change)="updateRatedYear($any($event.target).value)">
            @for (year of ratedYears; track year) {
              <option [value]="year">{{ year === 'all' ? i18n.t('filters.allRatedYears') : year }}</option>
            }
          </select>
        </label>
        <label class="filter">
          {{ i18n.t('filters.rating') }}
          <select [value]="ratingFilter()" (change)="updateRating($any($event.target).value)">
            @for (option of ratingOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </label>
        <label class="filter">
          {{ i18n.t('filters.sort') }}
          <select [value]="sortFilter()" (change)="updateSort($any($event.target).value)">
            @for (option of sortOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </label>
        <label class="filter">
          {{ i18n.t('filters.letter') }}
          <select [value]="letterFilter()" (change)="updateLetter($any($event.target).value)">
            @for (letter of letters; track letter) {
              <option [value]="letter">{{ letter === 'all' ? i18n.t('filters.allLetters') : letter }}</option>
            }
          </select>
        </label>
      </div>
    </div>

    @if (sortedRows.length === 0) {
      <div class="empty-state">
        <p>{{ i18n.t('library.empty') }}</p>
      </div>
    } @else if (viewMode() === 'tiles') {
      <div class="game-tiles">
        @for (game of sortedRows; track trackByTitle($index, game)) {
          <div class="game-tile">
            <app-cover-image
              class="tile-cover"
              [src]="coverUrlFor(game.id)"
              [alt]="game.title"
              [width]="null"
              [height]="null"
              [variant]="'fill'"
              [title]="game.title"
              [platform]="game.platform ?? i18n.t('label.platformUnknown')"
              [rating]="game.rating"
              [ratedOn]="game.placed ? i18n.formatDate(game.placed) : null"
            />
            <div class="tile-body">
              <p class="game-title tile-title">
                @for (part of highlightParts(game.title); track part.text + part.match) {
                  <span [class.highlight]="part.match">{{ part.text }}</span>
                }
              </p>
              <p class="muted tile-platform">
                {{ game.platform ?? i18n.t('label.platformUnknown') }} ·
                {{ game.year ?? i18n.t('label.yearUnknown') }}
              </p>
              @if (game.placed) {
                <p class="muted rated-line tile-rated">
                  {{ i18n.t('label.ratedOn') }} {{ i18n.formatDate(game.placed) }}
                </p>
              }
              <app-rating-stars
                class="tile-stars"
                [rating]="game.rating"
                [size]="24"
                [attr.aria-label]="game.rating?.toFixed(1) ?? i18n.t('label.na')"
              />
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="game-list">
        @for (game of sortedRows; track trackByTitle($index, game)) {
          <div class="game-item">
            <app-platform-logo
              class="game-platform-logo"
              [src]="platformImage(game.platform).src"
              [alt]="game.platform ?? i18n.t('label.platformUnknown')"
              [size]="36"
            />
            <app-cover-image
              [src]="coverUrlFor(game.id)"
              [alt]="game.title"
              [width]="44"
              [height]="62"
              [title]="game.title"
              [platform]="game.platform ?? i18n.t('label.platformUnknown')"
              [rating]="game.rating"
              [ratedOn]="game.placed ? i18n.formatDate(game.placed) : null"
            />
            <div class="game-details">
              <p class="game-title">
                @for (part of highlightParts(game.title); track part.text + part.match) {
                  <span [class.highlight]="part.match">{{ part.text }}</span>
                }
              </p>
              <p class="muted">
                {{ game.platform ?? i18n.t('label.platformUnknown') }} ·
                {{ game.year ?? i18n.t('label.yearUnknown') }}
              </p>
              @if (game.placed) {
                <p class="muted rated-line">
                  {{ i18n.t('label.ratedOn') }} {{ i18n.formatDate(game.placed) }}
                </p>
              }
            </div>
            <app-rating-stars
              class="rating-stars"
              [rating]="game.rating"
              [size]="36"
              [attr.aria-label]="game.rating?.toFixed(1) ?? i18n.t('label.na')"
            />
          </div>
        }
      </div>
    }
  </div>
</article>
